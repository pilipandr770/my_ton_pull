# render.yaml - Production deployment configuration for TON Staking Pool
# Key optimization: 1 worker to prevent duplicate APScheduler runs
# Build: combined Python backend + Next.js frontend
# Secrets: set DATABASE_URL, TON_API_KEY, STRIPE keys via Render Dashboard (NOT in repo)

services:
  - type: web
    name: ton-pool-unified
    runtime: python
    region: frankfurt
    plan: free
    branch: master

    buildCommand: |
      echo "üîß Installing Python dependencies..."
      pip install --upgrade pip
      pip install -r backend/requirements.txt
      
      echo "üîß Setting up Node.js..."
      corepack enable || true
      npm --version || true
      
      echo "üîß Building Next.js frontend..."
      cd frontend
      npm ci --no-fund
      npm run build
      cd ..
      
      echo "‚úÖ Build complete: backend + frontend ready"

    startCommand: cd backend && gunicorn --bind 0.0.0.0:$PORT --workers 1 --worker-class sync --timeout 120 --access-logfile - --error-logfile - app:app

    envVars:
      # Python/Node versions
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: NODE_VERSION
        value: 20.11.1
      
      # Flask configuration
      - key: FLASK_ENV
        value: production
      - key: SECRET_KEY
        generateValue: true
      
      # üîê Database (set in Render Dashboard, NOT hardcoded in repo!)
      - key: DATABASE_URL
        sync: false
      
      # üîê TON API (set in Render Dashboard)
      - key: TON_API_KEY
        sync: false
      
      # üîê Stripe keys (set in Render Dashboard)
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      
      # üîê SendGrid (set in Render Dashboard if using email)
      - key: SENDGRID_API_KEY
        sync: false
      
      # Frontend API configuration
      - key: NEXT_PUBLIC_API_URL
        value: ""  # Empty = same origin (Render URL)
      
      # TON Connect manifest
      - key: NEXT_PUBLIC_TON_MANIFEST_URL
        value: https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json
    
    # Auto-deploy on push to master
    autoDeploy: true
