# COPILOT_INSTRUCTIONS.md

## МЕТА
Побудувати окремий сервіс для TON-пулу на базі офіційних перевірених контрактів TON (nominator-pool / liquid-staking), де:
- **Контракти immutable:** Owner/Admin адреси = нульові; відсутні будь-які апгрейди чи керування після деплою.
- **Власник не отримує комісію:** весь дохід — учасникам пропорційно часткам.
- **Підписка 5 €/міс — лише офчейн:** доступ до сайту/аналітики/автоматизації через Stripe; смарт-контракт не залежить від підписки.
- **Користувач керує своїми активами сам:** тільки «поповнити → отримати share-jettons» та «забрати» (redeem).

## ТЕХНІЧНА АРХІТЕКТУРА
- **contracts/**: форк офіційного TON пулу; патч owner/admin → zero; тести; деплой у testnet/mainnet.
- **backend/** (Flask): адмінка/сайт, логін, Stripe підписка, webhook обробка, читання on-chain даних (поки що mock), API для UI.
- **scripts/**: PowerShell-скрипти для деплою контрактів та локального запуску.

## ОСНОВНІ ЗАВДАННЯ ДЛЯ COPILOT
1) **Контракти (форк і патч):**
   - Знайти ініціалізацію owner/admin у форкнутому офіційному репозиторії TON (nominator-pool або liquid-staking).
   - Замінити owner/admin на нульові адреси `0:000...000` (точна довжина нулів за форматом).
   - Переконатись, що відсутні функції upgrade/setOwner/setAdmin та приховані керуючі гачки.
   - Налаштувати мінімальний депозит (константа `min_stake`).
   - Відсутні будь-які fee-адреси власника.
   - Зібрати контракти, прогнати тести (unit/integration), додати базовий fuzz (за наявності тулінгу).
   - Підготувати артефакти деплою (адреси, state-init, data-cells).

2) **Backend (Flask, Stripe):**
   - Розгорнути готовий каркас (див. файли нижче).
   - Підключити Stripe: створення продукту + підписки (через dashboard), налаштувати `STRIPE_SECRET_KEY` і `STRIPE_WEBHOOK_SECRET`.
   - Реалізувати валідацію підписки (зберігати `customer_id`, `subscription_id` у локальній БД/файлі).
   - Додати middleware: якщо підписка не активна — редірект на сторінку оплати/інструкції.
   - Підготувати API endpoints для UI: `/api/pool`, `/api/position/:address` (спочатку mock; пізніше — інтеграція з TON indexer API).
   - Логи безпеки: IP rate-limit для webhook; перевірка підпису Stripe.

3) **DevEx та безпека:**
   - Додати `.env.example` і читання секретів через `python-dotenv`.
   - Налаштувати CORS/Headers (якщо додаватимемо фронтенд).
   - Додати базовий error handling і журналювання.

4) **Документація і тести:**
   - Оновити `README.md` із точними командами PowerShell.
   - Додати чек-ліст безпеки перед mainnet.
   - Підготувати скрипти деплою `scripts/deploy.ps1`.

## ПРИНЦИПИ/СТАНДАРТИ
- Без зміни логіки розподілу винагород у контрактному коді, окрім занулення owner/admin та параметрів min_stake.
- Код зрозумілий, із коментарями до кожної небезпечної ділянки (обробка bounce, повідомлень, edge cases).
- Нульові адреси задаються явно і тестуються.
- **ЖОДНИХ офчейн-тоглів, які впливають на кошти в контракті.** Все on-chain працює незалежно.

## ПРИНЙЯТТЯ (Acceptance Criteria)
- Контракти зкомпільовано, owner/admin = zero, пройдені тести на testnet, сформований diff.
- Backend приймає Stripe webhook, створює/підтверджує підписку, обмежує доступ до dashboard без активної підписки.
- scripts/deploy.ps1 — реальний робочий шаблон (місця для підстановки команд toolchain позначені).
- Повний README з PowerShell командами для Windows/VS Code.
- Без збереження приватних ключів валідатора у бекенді (ніяких ключів у репозиторії).

## ПОСЛІДОВНІСТЬ РОБІТ (для Copilot)
1. Створити структуру папок за зразком зі списку нижче.
2. Імпортувати початкові файли з цього документа (backend, scripts).
3. Додати `.env.example` і роз'яснення по змінних.
4. Під'єднати Stripe: додати route для webhook (`/stripe/webhook`), зразок у `backend/app.py`.
5. Підготувати PowerShell-команди у `README.md` (Windows).
6. Створити в `contracts/` інструкцію `README.md` як патч-гайд, додати `patch_owner_example.ps1`.
7. Написати TODO коментарі, де потрібна інтеграція з TON indexer.
8. Підготувати мінімальні тести (можна smoke) для бекенду (опційно).
9. Зробити git-коміти з інформативними повідомленнями.

## СТРУКТУРА ПРОЄКТУ

```
/ton-pool-project
├─ contracts/
│  ├─ README.md
│  ├─ patch_owner_example.ps1
│  └─ repo/                    # тут буде форк офіційного пулу TON (клон окремо)
├─ backend/
│  ├─ app.py
│  ├─ requirements.txt
│  └─ .env.example
├─ scripts/
│  └─ deploy.ps1
└─ COPILOT_INSTRUCTIONS.md
```

## ПРОМПТИ ДЛЯ COPILOT CHAT (вставляйте по черзі)
1) **Початкова ініціація**
> «Copilot, прочитай `COPILOT_INSTRUCTIONS.md`. Створи структуру папок і додай файли з точним умістом, як у документі. Не змінюй логіку — просто відтвори один-в-один.»

2) **Форк і патч контрактів**
> «Copilot, у папці `contracts/repo` знайди місце ініціалізації owner/admin, заміни їх на нульові адреси формату TON. Видали або заблокуйте будь-які апгрейд/сет-оунер функції. Підготуй diff і інструкцію до деплою на testnet. Не чіпай логіку розподілу.»

3) **Stripe інтеграція**
> «Copilot, у `backend/app.py` додай логіку збереження `customer_id`/`subscription_id` після `invoice.payment_succeeded` у локальний storage (поки JSON-файл). Додай перевірку підписки на `/dashboard`: без активної — редірект на сторінку інструкції.»

4) **Документація та скрипти**
> «Copilot, онови `contracts/README.md` і `scripts/deploy.ps1`: впиши реальні команди мого toolchain, де зараз стоїть заглушка, і додай приклад виклику для testnet/mainnet.»

5) **TON indexer (пізніше)**
> «Copilot, додай у `backend/app.py` ендпоінти `/api/pool`, `/api/position/:address` з mock-відповідями, і TODO: як інтегруватися з вибраним TON indexer API.»

## КЛЮЧОВІ ЗАСТЕРЕЖЕННЯ
- Не додавати у контракт жодної логіки підписок/авторизацій.
- Не зберігати приватні ключі у бекенді/репозиторії.
- Перед mainnet — провести аудит.

## DONE DEFINITION
- Все описане вище реалізовано, локально працює Flask, Stripe webhook відпрацьовує, контракти в testnet, README чіткий, скрипти працюють.
